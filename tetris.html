<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Typ3" content="text/html;" charset="UTF-8" />

<title>Insert title here</title>

<style type="text/css">
table {
	border-collapse: collapse;
}

table td {
	width: 20px;
	height: 20px;
	border: 1px solid black;
}
</style>

<script type="text/javascript">
	window.onload = function() {

		var width = 10; // 全体の横幅(セル数）)
		var height = 20; // 全体の高さ(セル数）)
		var moveSpeed = 300; // 画面再描画速度(ミリ秒）)
		var speed = 30;

		var table = [ '<table>' ];
		for ( var y = 0; y < height; y++) {

			table.push('<tr>');

			for ( var x = 0; x < width; x++) {
				table.push('<td></td>');
			}
			table.push('</tr>');
		}
		table.push('</table>');

		var top = 2; //画面に最初に描画されたのが(２７０度変換された状態であっても）画面にテトリス要素がすべて表示されるようにするため)
		var topBefore = top //「1回前の」状態を保存する系統の変数
		var left = Math.floor(width / 2); //画面の真ん中に初期配置
		var leftBefore = left;

		var w = width; //省略記述用。
		var angles = [ [ -1, 1, 2 ], [ -w, w, w + w ], [ -2, -1, 1 ],
				[ -w - w, -w, w ] ]; //テトリスブロックをtd配列の位置で表す
		var angle = 0;
		var partsBefore = [];

		var keys = {};
		var cells = document.getElementsByTagName('td');

		// キーボード入力を受け付ける
		document.onkeydown = function(e) {
			switch ((e || event).keyCode) {
			case 37: // キーボードの左キー
				keys.left = true;
				break;
			case 39: // キーボードの右キー
				keys.right = true;
				break;
			case 38: //キーボードの上キー
				keys.rotate = true;
				break;
			/**
			default:
				console.log(e.keyCode);
				break;
			 **/
			}

		}

		var tick = 0;
		var move = function() {

			tick++;
			leftBefore = left;

			// 別イベント関数 onkeydownにて記録した情報を受け取る
			if (keys.left && left > 0) {
				left--;
			}
			if (keys.right && left + 4 < width) {
				left++;
			}

			if (keys.rotate) {
				angle++
			}

			keys = {}; // 初期化（次のイベントで拾えるようにする）

			for ( var i = -1; i < partsBefore.length; i++) {
				var offset = partsBefore[i] || 0;
				cells[topBefore * width + leftBefore + offset].style.backgroundColor = '';
			}
			partsBefore = angles[angle % angles.length];

			for ( var i = -1; i < partsBefore.length; i++) {
				var offset = partsBefore[i] || 0;
				cells[top * width + left + offset].style.backgroundColor = 'red';
			}

			topBefore = top;

			// move関数の実行と、１マス下に動く挙動を分離する
			if (tick % speed == 0) {
				top++;
			}

			var info = 'プログラム内の経過：' + tick + '(' + left + ',' + top + ')';
			document.getElementById('info').innerHTML = info;

			if (top < height) {
				setTimeout(move, moveSpeed / speed);
			}
		}

		document.getElementById('view').innerHTML = table.join('');
		move();
	}
</script>

</head>
<body>

	<div id="explain">キーボードの上、左、右で対応</div>
	<div id="info"></div>
	<div id="view"></div>

</body>
</html>